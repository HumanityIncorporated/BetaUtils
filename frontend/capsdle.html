<!DOCTYPE html> 
<html>
  <head>
    <script src='./utils.js'></script>
    <title>Capsdle | BetaOS Systems</title>
    <script>
      let CURRROW = 0;
      let CURRCOL = 0;
      let CURRWORD = "";
      function addLetter(e) {
        // nowWord = "abcDC"
        let letter = "INVALID"
        
        if (e.keyCode >= 65 && e.keyCode <= 90) {
          letter = e.key;
          if (e.shiftKey) letter = letter.toUpperCase();
        }
        if (e.keyCode == 8) letter= "BKSP"
        if (e.keyCode == 13) letter= "ENTER";
        if (letter == "INVALID") return;
        else e.preventDefault();
        if (letter == "BKSP" && CURRCOL > 0) {
          CURRCOL --;
          updateHighlight();
          byId("row"+CURRROW+"letter"+CURRCOL).innerText = "";
          CURRWORD = CURRWORD.slice(0, CURRWORD.length-1)
        }
        else if (letter.length == 1 && CURRCOL < 5) {
          byId("row"+CURRROW+"letter"+CURRCOL).innerText = letter;
          CURRWORD += letter;
          CURRCOL++;
          updateHighlight();
        }
        else if (CURRCOL >= 5 && letter == "ENTER") {
          // verify letter
          let correctCt = 0;
          for (let i=0; i<5; i++) {
            // correct case, correct place
            if (CURRWORD [i] == nowWord[i]) {
              correctCt ++;
              byId("row"+CURRROW+"letter"+i).style.backgroundColor = "var(--system-green)";
            }
              // wrong case, correct place
            else if (CURRWORD[i] == swapCase(nowWord[i])) {
              byId("row"+CURRROW+"letter"+i).style.backgroundColor = "var(--system-blue)";
            }
              // correct case, wrong place
            else if (nowWord.indexOf(CURRWORD[i]) >= 0) {
              byId("row"+CURRROW+"letter"+i).style.backgroundColor = "var(--system-yellow)";
            }
              // wrong case, wrong place
            else if (nowWord.indexOf(swapCase(CURRWORD[i])) >= 0) {
              byId("row"+CURRROW+"letter"+i).style.backgroundColor = "var(--system-red)";
            }
            // does not exist in word
            else {
              byId("row"+CURRROW+"letter"+i).style.backgroundColor = "var(--system-overlay)";
            }
          }
          if (correctCt == 5) {
            alertDialog(`Congratulations! You have won in ${CURRROW+1} moves! 
            Press ENTER to share your score.`, 
            ()=>{ navigator.clipboard.writeText("Look, mother, I won in "+(CURRROW+1)+" moves!");}, 2);
            document.body.removeEventListener("keydown", addLetter);
            return;
          }
          CURRWORD = ""
          CURRCOL=0;
          CURRROW++;
          
          if (CURRROW < 12) {
            let newRow = document.createElement("div");
            newRow.id = "row"+CURRROW;
            newRow.innerHTML = `<div class="letter" id="row${CURRROW}letter0"></div>
              <div class="letter" id="row${CURRROW}letter1"></div>
              <div class="letter" id="row${CURRROW}letter2"></div>
              <div class="letter" id="row${CURRROW}letter3"></div>
              <div class="letter" id="row${CURRROW}letter4"></div>
            </div> `;
            byId("btnRow").appendChild(newRow);
            
          } else {
            document.body.removeEventListener("keydown", addLetter);
            alertDialog("You have lost.", ()=>{})
          }
          updateHighlight();
        }
      }

      function updateHighlight() {
        console.log(CURRROW, CURRCOL)
        for (let i=0; i<5; i++) byId("row"+CURRROW+"letter"+i).className = "letter";
        if (CURRCOL < 5) byId("row"+CURRROW+"letter"+CURRCOL).className = "letter activeLetter";
        for (let i=0; i<CURRROW; i++) byId("row"+i).className = "";
        byId("row"+CURRROW).className = "activeRow";
      }
      
      function swapCase(letter) {
        if (letters.indexOf(letter)>= 0) return letter.toUpperCase();
        else if (capitals.indexOf(letter) >= 0) return letter.toLowerCase();
        else return letter;
      }

      function hashIt(str, seed = 0) {
        let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
        for(let i = 0, ch; i < str.length; i++) {
            ch = str.charCodeAt(i);
            h1 = Math.imul(h1 ^ ch, 2654435761);
            h2 = Math.imul(h2 ^ ch, 1597334677);
        }
        h1  = Math.imul(h1 ^ (h1 >>> 16), 2246822507);
        h1 ^= Math.imul(h2 ^ (h2 >>> 13), 3266489909);
        h2  = Math.imul(h2 ^ (h2 >>> 16), 2246822507);
        h2 ^= Math.imul(h1 ^ (h1 >>> 13), 3266489909);
      
        return 4294967296 * (2097151 & h2) + (h1 >>> 0);
      };
      let nowWord = "ErRoR";
      const letters =  "abcdefghijklmnopqrstuvwxyz";
      const capitals = "QWERTYUIOPASDFGHJKLZXCVBNM";
      function updateCurrWord() {
        nowWord = "";
        let now = new Date(Date.now());
        let nowMins = Math.floor(now.getMinutes() / 5)*5; // floors to interval of 5 minutes.
        let nowHrs = now.getHours();
        let nowDay = now.toDateString();
        let nowHash = hashIt(nowDay+"/"+nowHrs+"/"+nowMins);
        let nextExpiry = 5*60*1000 - (Date.now())%(5*60*1000)
        for (let i=0; i<5; i++) {
          let currLetterIdx =Math.floor((nowHash%Math.pow(52, 5)) / Math.pow(52, i)) % 52;
          if (currLetterIdx < 26) nowWord += letters[currLetterIdx % 26];
          else nowWord += capitals[currLetterIdx % 26];
        }
      }

      function onLoad() {
        document.body.addEventListener("keydown", addLetter);
        setInterval(updateCurrWord, 200);
      }
    </script>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Display:wght@100;400;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="/globalformat.css">
    <style>
      .letter {
        background-color: var(--system-grey);
        outline: 1px solid var(--system-overlay);
        border-radius: 5px;
        width: 60px;
        font-size: 50px;
        height: calc(60px * 1.5);
        display: inline-block;
        vertical-align: top;
        transition: all 0.5s ease;
      }
      .activeRow > .letter {
        background-color: var(--system-bg);
      }
      .activeLetter {
        background-color: var(--system-yellow2) !important;
      }
      .flip-card {
        background-color: transparent;
        width: 400px;
        height: 400px;
        border: 2px solid #f1f1f1;
        perspective: 1000px;
      }
      
      .flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.8s;
        transform-style: preserve-3d;
        -webkit-backface-visibility: hidden; /* Safari */
        backface-visibility: hidden;
      }
      
      .flip-card:hover .flip-card-inner {
        transform: rotateX(180deg);
      }
      
      .flip-card-front, .flip-card-back {
        /* position: absolute; */
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden; /* Safari */
        backface-visibility: hidden;
      }
      
      
      .flip-card-back {
        transform: rotateX(180deg);
      }

    </style>
  </head>
  <body onload = "globalOnload(()=>{ onLoad();});">
    <div class="main_content">
      <header>
        <h2>CaPsDLe <sup style="font-size: 32px;" class="grn">BetaOS Services Exclusive!</sup></h2>
        <hr class="rounded">
      </header>
      <div class="btnRow" id="btnRow">
        <div id="row0" class="activeRow">
          <div class="letter activeLetter" id="row0letter0"></div>
          <div class="letter" id="row0letter1"></div>
          <div class="letter" id="row0letter2"></div>
          <div class="letter" id="row0letter3"></div>
          <div class="letter" id="row0letter4"></div>
          <div class="overlayer" id="overlayer0"></div>
        </div> 
      </div>
      <!-- <div class="flip-card">
      <div class="flip-card-inner">
        <div class="flip-card-front">
         <h2>hello</h2>
        </div>
        <div class="flip-card-back">
          <h1>INSERT YOUR HEADER FOR BACK OF CARD HERE</h1>
          <p>Include first sentence to appear on back of card</p>
          <p>Include second sentence to appear on back of card</p>
        </div>
      </div>
    </div> -->
      <a class="btn override" href="/">
        <span class="material-symbols-outlined">arrow_back_ios</span>
        Return to home<div class="anim"></div></a>
    </div>
    <dialog class="internal" id="dialog_v2">This thing is supposed to be a dialog box.</dialog>
    <div class="overlay" id="overlay">
      <div class="internal">
        <p class="fsmed" id="alerttext">Hey, some text here</p>
        <button class="btn szTwoThirds" onclick="closeAlert()">
          Continue
          <span class="material-symbols-outlined">arrow_forward_ios</span>
          <div class="anim"></div>
        </button>
      </div>
    </div>
  </body>
</html>
<!DOCTYPE html>
<html>
  <head>
    <script src='./utils.js'></script>
    <title>Administrative panel | BetaOS Systems</title>
    <script>
      const accessLevels = ["Error-level", "User", "Admin", "Super-admin"];
      let grid = [];
      let initQ = false;
      let revealed = [];
      let w = 20;
      let h = 20;
      let mineCt = 50;
      let revealedOK = 0;
      function onLoad() {
         // do stuff i guess
        grid = [];
        initQ = false;
        revealed = [];
        revealedOK = 0;
        for (let y=0; y<h; y++) {
          grid.push([]);
          revealed.push([]);
          grid[y].length = w;
          revealed[y].length = w;
          grid[y].fill(false);
          revealed[y].fill(-1);
          let swp = byId("sweep");
          let div = document.createElement("div");
          div.id="row"+y;
          div.className="row";
          for (let x=0; x<w; x++) {
            
            let btn = document.createElement("button");
            btn.className = "btn gry cell notooltip override";
            btn.id=y+"-"+x;
            btn.innerHTML = `
              <span class="material-symbols-outlined override">question_mark</span> `;
            btn.onclick=(ev)=>{onClick(ev, y, x)};
            btn.oncontextmenu=(ev)=>{onClick(ev, y, x)};
            div.appendChild(btn);
          }
          swp.appendChild(div);
        }
        console.log(grid);
        // initMines(6,5)
      }
      function onClick(thing, y, x) {
        if (thing.ctrlKey || thing.shiftKey  || thing.button != 0) {
          thing.preventDefault();
          console.log('here');
          flag(y, x);
        }
        else reveal(y, x);
      }
      function flag(y, x) {
        if (revealed[y][x] == -1) {
          revealed[y][x] = -2;
          byId(y+'-'+x).innerHTML = `<span class="material-symbols-outlined override">flag</span>`;
        }
        else if (revealed[y][x] == -2) {
          revealed[y][x] = -1; 
          byId(y+'-'+x).innerHTML = `<span class="material-symbols-outlined override">question_mark</span>` ;
        }
      }
      function initMines(x, y) {
        // avoid area around x, y
        let i = 0;
        
        while (i < mineCt) {
          let newX = -1;
          let newY = -1;
          do {
            newX = Math.floor(Math.random()*w);
            newY = Math.floor(Math.random()*h);
          }
          while (grid[newY][newX]);
          let dx = newX-x;
          let dy = newY-y;
          let dist = Math.sqrt(dx*dx + dy*dy);
          if (dist > 2 && (dist > 5 || Math.random()*dist > 1)) {
            if (dist <= 5) console.log("dist "+dist)
            grid[newY][newX] = true;
            i++;
            console.log(i, "mines placed")
          }
          
        } // i

        prt();
      }
      const word = ['zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'error'];
      function reveal(y, x) {
        // console.log(y, x);
        if (y >= h || x >= w || x<0 || y<0 || revealed[y][x] >= 0) return;
        if (revealed[y][x] == -2) return;
        if (!initQ) {
          initMines(x, y);
          initQ = true;
        }
        if (grid[y][x]) {
          revealed[y][x]=9;
          alertDialog("You lost!", ()=>{resetGrid();}, 2);
          let cell = byId(y+"-"+x);
          cell.innerHTML = `<span class="material-symbols-outlined override red nohover nooutline">explosion</span> `
          cell.className += " revealed nohover"
          return;
        }
        let surrounding = 0;
        if (y<h-1 && grid[y+1][x]) surrounding++;
        if (x<w-1 && grid[y][x+1]) surrounding++;
        if (y>0 && grid[y-1][x]) surrounding++;
        if (x>0 && grid[y][x-1]) surrounding++;
        if (y<h-1 && x<w-1 && grid[y+1][x+1]) surrounding++;
        if (y<h-1 && x>0 && grid[y+1][x-1]) surrounding++;
        if (y>0 && x<w-1 && grid[y-1][x+1]) surrounding++;
        if (y>0 && x>0 && grid[y-1][x-1]) surrounding++;
        if (surrounding > 0) {
          // console.log(surrounding)
          revealed[y][x] = surrounding;
          revealedOK++;
          let cell = byId(y+"-"+x);
          cell.innerHTML = `<span class="override ${word[surrounding]}">${surrounding}</span>`;
          cell.className += " revealed nohover"
          if (revealedOK == w*h - mineCt) {
            alertDialog("You won!");
          }
          return;
        }
        else {
          revealed[y][x] = 0;
          let cell = byId(y+"-"+x)
          revealedOK++;
          
          cell.innerHTML = `<span class="override zero">0</span>`;
          cell.className += " revealed nohover";
          if (revealedOK == w*h - mineCt) {
            alertDialog("You won!");
            return;
          }
          // console.log("none")
          reveal(y+1,x)   
          reveal(y,x+1)   
          reveal(y-1,x)   
          reveal(y,x-1)   
          reveal(y+1,x+1) 
          reveal(y+1,x-1) 
          reveal(y-1,x+1) 
          reveal(y-1,x-1)
        }
        
      }
      
      function prt() {
        let line = "";
        for (let y=0; y<h; y++) {
          for (let x=0; x<w; x++) {
            let char = revealed[y][x];
            if (char == -1) char = "?"
            if (char == -1) char = "*"
            line += char;
          }
          line += "\n"
        }
        console.log(line);
        return line;
      }
      function resetGrid() {
        byId("sweep").innerHTML = "";
        onLoad();
        
      }
    </script>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Display:wght@100;400;500&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="/globalformat.css">
    <style>
      .row {
        display: flex;
        width: 60%;
        /* over */
        /* flex-grow: 1; */
      }
      #sweep {
        /* overflow-y: auto; */
      }
      .cell {
        margin: 0px;
        padding: 0px;
        border-radius: 2px;
        min-height: unset;
        flex-grow: 1;
        transition: all 0.3s ease;
        aspect-ratio: 1 / 1;
        border: solid 1px var(--system-grey3);
        /* bor */
      }
      .cell > span {
        font-size: calc(100% - 20px) !important;
        font-weight: 500;
        top: 50%;
        left: 50%;
        transform: translateY(-50%) translateX(-50%);
        position: absolute;
      }
      .cell:active, .cell:focus, .cell *:active, .cell *:focus {
        outline: none;
      }
      .zero {}
      .one {color: #00bb00;}
      .two {color: var(--system-yellowtext);}
      .three {color: var(--system-red);}
      .four {color: #8b00ff;}
      .five {color: var(--system-blue);}
      .six {color: var(--system-black);}
      .cell.revealed, .cell.revealed:hover {background-color: #e8c09c !important;}
      /* .gry {} */
    </style>
  </head>
  <body onload = "globalOnload(onLoad)" oncontextmenu='return false;'>
    <div class="main_content">
      <header>
        <h2>SweepThatMine</h2>
        <hr class="rounded">
      </header>
      <div id="sweep"></div>
      <a class="btn szFull override" href="/">
        <span class="material-symbols-outlined">arrow_back_ios</span>
        Return to home<div class="anim"></div></a>
    
      </div>
    </div>
    <div class="overlay" id="overlay">
      <div class="internal">
        <p class="fsmed" id="alerttext">Hey, some text here</p>
        <button class="btn szTwoThirds" onclick="closeAlert()">
          Continue
          <span class="material-symbols-outlined">arrow_forward_ios</span>
          <div class="anim"></div>
        </button>
      </div>
    </div>
  </body>
</html>
{
  "version": 3,
  "sources": ["../server.ts"],
  "sourcesContent": ["// we have a front-end!\nconst express = require('express');\nconst path = require('path');\nconst fs = require('fs');\nconst bodyParser = require('body-parser');  \n// Create application/x-www-form-urlencoded parser  \nconst urlencodedParser = bodyParser.urlencoded({ extended: false })  \nconst app = express();\nconst port = 4000;\nimport {sysRooms, hidRooms} from './initialiser';\nimport { validate } from './accessControl';\nimport {systemLog} from './misc';\n\nvar RateLimit = require('express-rate-limit');\n\nexport let pushEvents: any[][] = [];\nexport let hidEvents: any[][] = [];\n// import {pushEvents} from './initialiser';\n// \n\nexport async function updateServer() { \n  systemLog(\"\");\n  \n  systemLog(\"Server active!\")\n  var limiter = RateLimit({\n    windowMs: 10*1000, // 1 minute\n    max: 50,\n    message: \"Too many requests, please try again later.\",\n    statusCode: 429, // 429 status = Too Many Requests (RFC 6585)\n  });\n  \n  // apply rate limiter to all requests\n  app.use(limiter);\n  \n  app.get('/', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'index.html' ));\n  });\n  app.get('/favicon.ico', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'favicon.ico' ));\n  });\n  app.get('/NotoSansDisplay-Variable.ttf', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'NotoSansDisplay-Variable.ttf' ));\n  });\n  app.get('/status/status_raw.html', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'status_raw.html' ));\n  });\n  \n  app.get('/frontend.js', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../.build/frontend', 'frontend.js' ));\n  });\n\n  app.get('/login.js', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../.build/frontend', 'login.js' ));\n  });\n\n  app.get('/login', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'login.html' ));\n  });\n\n  app.get('/admin', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'admin.html' ));\n  });\n\n  app.get('/logout', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'logout.html' ));\n  });\n\n  app.get('/signup', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'signup.html' ));\n  });\n  \n  app.post('/login', urlencodedParser, function (req:any, res:any) {  \n   // Prepare output in JSON format  \n    if (req.body.action == \"bMsg\") res.end(JSON.stringify(\"ACCESS\"));\n    validate(decodeURIComponent(req.body.user) as string, decodeURIComponent(req.body.pass) as string, req.body.action, req.body.access as string, res, req.body.token as string)\n   \n  });\n\n  app.get(\"/stream?*\", async (req:any, res:any) => {\n    res.set({\n      'Cache-Control': 'no-cache',\n      'Content-Type': 'text/event-stream',\n      'Connection': 'keep-alive'\n    });\n    res.flushHeaders();\n\n    // Tell the client to retry every 10 seconds if connectivity is lost\n    \n    res.write(\"retry:500\\n\\n\");\n    // console.log(req.query.room)\n    \n    let roomIdx = sysRooms.indexOf(\"OnlineSUPPORT|\"+req.query.room);\n    let roomIdx2 = hidRooms.indexOf(\"HIDDEN|\"+req.query.room);\n    // console.log(roomIdx2);\n    if (roomIdx < 0 && roomIdx2 < 0) {\n      res.end();\n      console.log(\"Invalid room: \"+req.query.room);\n      return;\n    }\n    // console.log(roomIdx);\n    if (roomIdx >= 0) pushEvents[roomIdx].push(res);\n    else hidEvents[roomIdx2].push(res);\n    res.on(\"close\", () => {\n      if (roomIdx >= 0) pushEvents[roomIdx].splice(pushEvents[roomIdx].indexOf(res), 1);\n      else hidEvents[roomIdx2].splice(hidEvents[roomIdx2].indexOf(res), 1);\n      res.end();\n      // console.log(\"Removed stream\");\n    });\n  });\n\n  app.get(\"/testevents\", (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'support_v2.html' ));\n  })\n\n  app.get('/status', (req:any, res:any) => {\n    let str = \"BetaUtilities is in: \";\n    let prefixedRms = [];\n    let euphRooms = 0;\n    for (let i=0; i<sysRooms.length; i++) {\n      if (!sysRooms[i].match(\"\\\\|\")) {\n        euphRooms++;\n        prefixedRms.push(`<a href=\"https://euphoria.io/room/${sysRooms[i]}\">&${sysRooms[i]}</a>`);\n      }\n      else {\n        let roomName = sysRooms[i].match(\"\\\\|(.+)\")[1];\n        prefixedRms.push(`<a href=\"/support?room=${roomName}\">#${roomName}</a>`);\n      }\n    }\n    for (let j = 0; j < prefixedRms.length - 1; j++) { str += prefixedRms[j] + \", \"; }\n    str += (prefixedRms.length>1?\"and \":\"\")+prefixedRms[prefixedRms.length - 1] + \"!\";\n    if (euphRooms == 0) {\n      str += \"<br> ERROR: Rooms failed on <a href='https://euphoria.io'>euphoria</a>\";\n    } // rooms failed\n    fs.writeFileSync(\"frontend/status_raw.html\",str);\n    res.sendFile(path.join( __dirname, '../frontend', 'status.html' ));\n  });\n\n  app.get(\"/globalformat.css\", (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'globalformat.css' ));\n  }); \n\n  app.get(\"/support\", (req:any, res:any) => {\n    let roomIdx = sysRooms.indexOf(\"OnlineSUPPORT|\"+req.query.room);\n    let roomIdx2 = hidRooms.indexOf(\"HIDDEN|\"+req.query.room);\n    // console.log(roomIdx, req.query.room)\n    if (roomIdx < 0 && roomIdx2 < 0 && req.query.room) {res.sendFile(path.join( __dirname, '../frontend', 'roomNotFound.html'))}\n    else if(req.query.room) res.sendFile(path.join( __dirname, '../frontend', 'support.html'));\n    else res.sendFile(path.join( __dirname, '../frontend', 'supportIndex.html'));\n    // validate(\"\", \"\", \"checkAccess\", \"\", res, req.query.token)\n  })\n\n  app.get(\"/todo\", (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'TODO.html' ));\n    // validate(\"\", \"\", \"checkAccess\", \"\", res, req.query.token)\n  })\n  \n  app.get(\"/syslog\", (req:any, res:any) => {\n    validate(\"\", \"\", \"checkAccess_A\", \"\", res, req.query.token)\n  })\n\n  app.get('/about', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'about.html' ));\n  });\n\n  app.get('/commands', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'commands.html' ));\n  });\n\n  app.get('/contact', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'contact.html' ));\n  });\n\n  app.get('*.js.map', (req:any, res:any)=> {\n    res.end();\n  })\n  \n  app.get('/*', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', '404.html' ));\n  });\n\n  // app.use(function(req:any, res:any, next:any) {\n  //     res.status(404).render('frontend/landing.html');\n  // });\n  // app.get()\n  \n  app.listen(port, () => {\n    systemLog(`Front-end is running on ${port}.`);\n  });\n}\n\nexport function sendMsgAllRooms(room:string, msg:string) {\n  let roomId = sysRooms.indexOf(\"OnlineSUPPORT|\"+room);\n  let roomId2 = hidRooms.indexOf(\"HIDDEN|\"+room);\n  if (roomId<0 && roomId2<0) {\n    console.log(\"invalidROOM:\"+room)\n    return;\n  }\n  else if (roomId >= 0) \n    for (let i=0; i<pushEvents[roomId].length; i++) \n      pushEvents[roomId][i].write(\"data:\"+msg+\"\\n\\n\");\n  else \n    for (let i=0; i<hidEvents[roomId2].length; i++) \n      hidEvents[roomId2][i].write(\"data:\"+msg+\"\\n\\n\");\n}"],
  "mappings": "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",
  "names": []
}

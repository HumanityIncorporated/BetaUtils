{
  "version": 3,
  "sources": ["../server.ts"],
  "sourcesContent": ["// we have a front-end!\nconst express = require('express');\nconst path = require('path');\nconst fs = require('fs');\nconst bodyParser = require('body-parser');  \n// Create application/x-www-form-urlencoded parser  \nconst urlencodedParser = bodyParser.urlencoded({ extended: false })  \nconst app = express();\nconst port = 4000;\nimport {rooms} from './messageHandle';\nimport { validate } from './accessControl';\nimport {systemLog} from './misc';\n\nvar RateLimit = require('express-rate-limit');\n\nlet pushEvents: any[] = [];\n\nexport async function updateServer() { \n  systemLog(\"\");\n  \n  systemLog(\"Server active!\")\n  var limiter = RateLimit({\n    windowMs: 10*1000, // 1 minute\n    max: 50,\n    message: \"Too many requests, please try again later.\",\n    statusCode: 429, // 429 status = Too Many Requests (RFC 6585)\n  });\n  \n  // apply rate limiter to all requests\n  app.use(limiter);\n  \n  app.get('/', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'index.html' ));\n  });\n  app.get('/favicon.ico', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'favicon.ico' ));\n  });\n  app.get('/NotoSansDisplay-Variable.ttf', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'NotoSansDisplay-Variable.ttf' ));\n  });\n  app.get('/status/status_raw.html', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'status_raw.html' ));\n  });\n  \n  app.get('/frontend.js', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../.build/frontend', 'frontend.js' ));\n  });\n\n  app.get('/login.js', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../.build/frontend', 'login.js' ));\n  });\n\n  app.get('/login', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'login.html' ));\n  });\n\n  app.get('/admin', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'admin.html' ));\n  });\n\n  app.get('/logout', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'logout.html' ));\n  });\n\n  app.get('/signup', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'signup.html' ));\n  });\n  \n  app.post('/login', urlencodedParser, function (req:any, res:any) {  \n   // Prepare output in JSON format  \n    if (req.body.action == \"bMsg\") res.end(JSON.stringify(\"ACCESS\"));\n    validate(decodeURIComponent(req.body.user) as string, decodeURIComponent(req.body.pass) as string, req.body.action, req.body.access as string, res, req.body.token as string)\n   \n  });\n\n  app.get(\"/stream\", async (req:any, res:any) => {\n    res.set({\n      'Cache-Control': 'no-cache',\n      'Content-Type': 'text/event-stream',\n      'Connection': 'keep-alive'\n    });\n    res.flushHeaders();\n\n    // Tell the client to retry every 10 seconds if connectivity is lost\n    pushEvents.push(res);\n    res.write(\"retry:500\\n\\n\");\n    // console.log(\"Added stream\")\n    res.on(\"close\", () => {\n      pushEvents.splice(pushEvents.indexOf(res), 1);\n      res.end();\n      // console.log(\"Removed stream\");\n    });\n  });\n\n  app.get(\"/testevents\", (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'support_v2.html' ));\n  })\n\n  app.get('/status', (req:any, res:any) => {\n    let str = \"BetaUtilities is in: <a href='/support'>Online Support</a>\";\n    for (let j = 0; j < rooms.length - 1; j++) { \n      str += `, <a href=\"https://euphoria.io/room/${rooms[j]}\">&${rooms[j]}</a>` ; \n    }\n    str += ` ${rooms.length>1?\"and \":\"\"}<a href=\"https://euphoria.io/room/${rooms[rooms.length-1]}\">&${rooms[rooms.length-1]}</a>!  `;\n    if (rooms.length == 0) {\n      str = \"ERROR\";\n    } // rooms failed\n    fs.writeFileSync(\"frontend/status_raw.html\",str);\n    res.sendFile(path.join( __dirname, '../frontend', 'status.html' ));\n  });\n\n  app.get(\"/globalformat.css\", (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'globalformat.css' ));\n  }); \n\n  app.get(\"/support\", (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'support.html' ));\n    // validate(\"\", \"\", \"checkAccess\", \"\", res, req.query.token)\n  })\n\n  app.get(\"/todo\", (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'TODO.html' ));\n    // validate(\"\", \"\", \"checkAccess\", \"\", res, req.query.token)\n  })\n  \n  app.get(\"/syslog\", (req:any, res:any) => {\n    validate(\"\", \"\", \"checkAccess_A\", \"\", res, req.query.token)\n  })\n\n  app.get('/about', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'about.html' ));\n  });\n\n  app.get('/contact', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', 'contact.html' ));\n  });\n\n  app.get('*.js.map', (req:any, res:any)=> {\n    res.sendFile(path.join( __dirname, '../.build', req.url));\n  })\n  \n  app.get('/*', (req:any, res:any) => {\n    res.sendFile(path.join( __dirname, '../frontend', '404.html' ));\n  });\n\n  // app.use(function(req:any, res:any, next:any) {\n  //     res.status(404).render('frontend/landing.html');\n  // });\n  // app.get()\n  \n  app.listen(port, () => {\n    systemLog(`Front-end is running on ${port}.`);\n  });\n}\n\nexport function sendMsgAllRooms(msg:string) {\n  for (let i=0; i<pushEvents.length; i++) {\n    // console.log(\"Writing \"+msg);\n    pushEvents[i].write(\"data:\"+msg+\"\\n\\n\");\n  }\n}"],
  "mappings": "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",
  "names": []
}

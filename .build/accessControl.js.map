{
  "version": 3,
  "sources": ["../accessControl.ts"],
  "sourcesContent": ["import { WS } from \"./wsHandler\";\n\n\n// export function requestHash(user:string, pwd:string, callback:any) {\n//   bcrypt.hash(pwd, saltRounds, function(err:any, hash:string) {\n    \n//     const db2 = require(\"@replit/database\")\n//     console.log(err, hash)\n//     db2.set(\"hashed\", hash as string).then(()=>{});\n    \n//     returnedHash(user, hash, callback);\n//       // Store hash in your password DB.\n//   });\n// }\nexport function validate(user:string, pwd:string, action:string, access:string, callback:any, token:string=\"\") {\n  console.log(\"Validating as \"+user+\" with password \"+pwd+\" with action\"+action+\" - token \"+token);\n  if (action==\"logout\") {\n    console.log(\"Logging out \"+token)\n    WS.db.delete(token);\n    callback.end(JSON.stringify(0));\n    return;\n  }\n  // if (action==\"server\") { // \n    // console.log(\"Logging token with user \"+user+\" with expiry\"+Date.now()+1000*60*60*24*30);\n  // }?\n  if (action==\"add\") {\n    console.log(token);\n    WS.db.get(token).then((data:string)=>{\n      console.log(\"Data: \"+data);\n      if (data == null) {\n        console.log(\"No active session\");\n        callback.end(JSON.stringify(\"NOACTIVE\"));\n        return;\n      }\n      let expiryTime = Number(data.match(\"[0-9]+$\")[0]);\n      console.log(\"This token expiring in: \"+(expiryTime-Date.now()) + \" ms\");\n      if (expiryTime<Date.now()) {\n        console.log(\"Token expired.\")\n        WS.db.delete(token);\n        callback.end(JSON.stringify(\"EXPIRE\"));\n        return;\n      }\n      WS.db.get(data.split(\" \")[0]+\"^PERM\").then((perms:string)=> {\n        if (perms!=\"2\"){\n          console.log(\"Permissions insufficient.\")\n          callback.end(JSON.stringify(\"ACCESS\"));\n        }\n        else {\n          console.log(\"Access granted; Token not expired. Adding \"+user+\" with permissions\"+access);\n          WS.db.set(user, pwd);\n          WS.db.set(user+\"^PERM\", access);\n          let response = 0;\n          callback.end(JSON.stringify(response));\n        }\n      }); // check permissions of token\n    });\n   return; \n  }\n  WS.db.get(user).then((value:any)=>{\n    if (value == pwd) {// pwd validated. \n      console.log(\"Password OK\")\n      WS.db.get(user+\"^PERM\").then((perm:any)=>{\n        console.log(perm);\n        callback.end(JSON.stringify(perm));  \n      })\n    } // validate pwd\n    else {\n      if (action == \"login\") {\n        let response = 0;\n        callback.end(JSON.stringify(response));\n      }\n    };\n    \n    let exp = (Date.now()+1000*30);\n    console.log(\"Logging token with user \"+user+\" with expiry\"+exp+\" Current time:\"+Date.now());\n    WS.db.set(token, user+\" \"+exp);\n  })\n}"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBAAmB;AAcZ,SAAS,SAAS,MAAa,KAAY,QAAe,QAAe,UAAc,QAAa,IAAI;AAC7G,UAAQ,IAAI,mBAAiB,OAAK,oBAAkB,MAAI,iBAAe,SAAO,cAAY,KAAK;AAC/F,MAAI,UAAQ,UAAU;AACpB,YAAQ,IAAI,iBAAe,KAAK;AAChC,wBAAG,GAAG,OAAO,KAAK;AAClB,aAAS,IAAI,KAAK,UAAU,CAAC,CAAC;AAC9B;AAAA,EACF;AAIA,MAAI,UAAQ,OAAO;AACjB,YAAQ,IAAI,KAAK;AACjB,wBAAG,GAAG,IAAI,KAAK,EAAE,KAAK,CAAC,SAAc;AACnC,cAAQ,IAAI,WAAS,IAAI;AACzB,UAAI,QAAQ,MAAM;AAChB,gBAAQ,IAAI,mBAAmB;AAC/B,iBAAS,IAAI,KAAK,UAAU,UAAU,CAAC;AACvC;AAAA,MACF;AACA,UAAI,aAAa,OAAO,KAAK,MAAM,SAAS,EAAE,EAAE;AAChD,cAAQ,IAAI,8BAA4B,aAAW,KAAK,IAAI,KAAK,KAAK;AACtE,UAAI,aAAW,KAAK,IAAI,GAAG;AACzB,gBAAQ,IAAI,gBAAgB;AAC5B,4BAAG,GAAG,OAAO,KAAK;AAClB,iBAAS,IAAI,KAAK,UAAU,QAAQ,CAAC;AACrC;AAAA,MACF;AACA,0BAAG,GAAG,IAAI,KAAK,MAAM,GAAG,EAAE,KAAG,OAAO,EAAE,KAAK,CAAC,UAAgB;AAC1D,YAAI,SAAO,KAAI;AACb,kBAAQ,IAAI,2BAA2B;AACvC,mBAAS,IAAI,KAAK,UAAU,QAAQ,CAAC;AAAA,QACvC,OACK;AACH,kBAAQ,IAAI,+CAA6C,OAAK,sBAAoB,MAAM;AACxF,8BAAG,GAAG,IAAI,MAAM,GAAG;AACnB,8BAAG,GAAG,IAAI,OAAK,SAAS,MAAM;AAC9B,cAAI,WAAW;AACf,mBAAS,IAAI,KAAK,UAAU,QAAQ,CAAC;AAAA,QACvC;AAAA,MACF,CAAC;AAAA,IACH,CAAC;AACF;AAAA,EACD;AACA,sBAAG,GAAG,IAAI,IAAI,EAAE,KAAK,CAAC,UAAY;AAChC,QAAI,SAAS,KAAK;AAChB,cAAQ,IAAI,aAAa;AACzB,0BAAG,GAAG,IAAI,OAAK,OAAO,EAAE,KAAK,CAAC,SAAW;AACvC,gBAAQ,IAAI,IAAI;AAChB,iBAAS,IAAI,KAAK,UAAU,IAAI,CAAC;AAAA,MACnC,CAAC;AAAA,IACH,OACK;AACH,UAAI,UAAU,SAAS;AACrB,YAAI,WAAW;AACf,iBAAS,IAAI,KAAK,UAAU,QAAQ,CAAC;AAAA,MACvC;AAAA,IACF;AAAC;AAED,QAAI,MAAO,KAAK,IAAI,IAAE,MAAK;AAC3B,YAAQ,IAAI,6BAA2B,OAAK,iBAAe,MAAI,mBAAiB,KAAK,IAAI,CAAC;AAC1F,wBAAG,GAAG,IAAI,OAAO,OAAK,MAAI,GAAG;AAAA,EAC/B,CAAC;AACH;",
  "names": []
}

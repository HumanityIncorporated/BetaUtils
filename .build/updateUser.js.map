{
  "version": 3,
  "sources": ["../updateUser.ts"],
  "sourcesContent": ["import {authDB, userRegex, hashingOptions} from './consts';\nconst argon2 = require('argon2');\nimport {userRequest} from './userRequest'\n\nexport async function updateUser(user:string, oldPass:string, newPass:string, newPermLevel:number, token:string) {\n  let NOUPDATE = false;\n  if (!user.match(userRegex)) {\n    return {status:\"ERROR\", data:{error:\"Invalid user string!\"}, token:token}\n  }\n  if (newPass.length == 0) {\n    NOUPDATE = true;\n    // return {status:\"ERROR\", data:{error:\"No password provided!\"}, token:token}\n  }\n  let tokenData:{associatedUser:string, expiry:number} = await authDB.findOne({fieldName:\"Token\", token:token});\n  if (!tokenData) {\n    return {status:\"ERROR\", data:{error:\"Cannot update user information: Your session could not be found!\"}, token:\"\"}\n  }\n  let userData:{permLevel:number, pwd:string} = await authDB.findOne({fieldName:\"UserData\", user:tokenData.associatedUser});\n  if (Date.now() > tokenData.expiry) {\n    return {status:\"ERROR\", data:{error:\"Cannot update user information: Your session has expired!\"}, token:\"\"};\n  }\n  let newUserData = await authDB.findOne({fieldName:\"UserData\", user:user});\n  if (userData.permLevel >=2 && \n      (!newUserData || newUserData.permLevel< userData.permLevel)\n     && newPermLevel < userData.permLevel) {\n    // administrators can update other accounts but not other admins\n    await authDB.updateOne({fieldName:\"UserData\", user:user}, \n        {$set:{permLevel:newPermLevel}}, {upsert:true});\n    if (!NOUPDATE) {\n      await authDB.updateOne({fieldName:\"UserData\", user:user}, \n        {$set:{pwd: await argon2.hash(newPass, hashingOptions)}}, {upsert:true});\n    }\n    return {status:\"SUCCESS\", data:{perms: newPermLevel}, token:token};\n  }\n  else if (await argon2.verify(userData.pwd, oldPass)) { \n    // unless you have their password, I suppose. but you can't provide that without editing the headers.\n    await authDB.updateOne({fieldName:\"UserData\", user:tokenData.associatedUser}, \n        {$set:{pwd:await argon2.hash(newPass, hashingOptions)}});\n    return {status:\"SUCCESS\", data:{perms:userData.permLevel}, token: token};\n  } else {\n    return {status: \"ERROR\", data:{error:\"Cannot update user information: Access denied!\"}, token:token};\n  }\n}\n\nexport async function realias(newalias:string, token:string) {\n  let tokenData:{associatedUser:string, expiry:number} = await authDB.findOne({fieldName:\"Token\", token:token});\n  if (!tokenData) {\n    return {status:\"ERROR\", data:{error:\"Cannot update user information: Your session could not be found!\"}, token:\"\"}\n  }\n  if (Date.now() > tokenData.expiry) {\n    return {status:\"ERROR\", data:{error:\"Cannot update user information: Your session has expired!\"}, token:\"\"};\n  }\n  if (newalias.length>30) return {status:\"ERROR\",data:{error:\"Alias too long\"}, token:token};\n  await authDB.updateOne({fieldName:\"UserData\", user:tokenData.associatedUser}, {\n    $set:{alias:newalias}\n  });\n  return {status:\"SUCCESS\", data:null, token:token};\n}\n\nexport async function toggleTheme(token) {\n  let uInfo = await userRequest(token);\n  if (uInfo.status != \"SUCCESS\") {\n    return uInfo;\n  }\n  else {\n    await authDB.updateOne({user:uInfo.data.user, fieldName:\"UserData\"}, {\n      $set: {darkTheme: !uInfo.data.darkQ}\n    }, {upsert: true})\n    return {status:\"SUCCESS\", data:null, token:token};\n  }\n}"],
  "mappings": "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",
  "names": []
}

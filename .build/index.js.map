{
  "version": 3,
  "sources": ["../index.ts"],
  "sourcesContent": ["// Copyright (c) 2023 BetaOS\nimport {WebSocket} from 'ws';\nimport {init} from './initialiser'\nimport {replyMessage} from './messageHandle';\nimport { updateActive } from './messageHandle';\nconst Database = require(\"@replit/database\")\n\n// we have a front-end!\nconst express = require('express');\nconst app = express();\nconst port = 4000;\nimport {rooms} from './messageHandle';\n\napp.get('/', (req:any, res:any) => {\n  let str = \"BetaUtilities is is in: \";\n  for (let j = 0; j < rooms.length - 1; j++) { \n    str += `<a href=\"https://euphoria.io/room/${rooms[j]}\"> &${rooms[j]}</a>,` ; \n  }\n  str += \"and &\" + rooms[rooms.length - 1] + \"!\";\n  res.send(str);\n  console.log(\"Accessed.\")\n})\napp.listen(port, () => {\n  console.log(`Success! Your application is running on port ${port}.`);\n});\n \nexport class WS \n{\n  static CALLTIMEOUT = 5000;\n  url:string\n  nick:string;\n  socket: WebSocket;\n  pausedQ=false;\n  roomName:string;\n  pauser:string|null = null;\n  failedQ = false;\n  callTimes:number[]=[];\n  callReset:NodeJS.Timeout|null = null;\n  callStatus=-1;\n  transferOutQ = false; // is a room that one should recommend transferring out?\n  bypass = false;\n  confirmcode = -1;\n  static db = new Database();\n  static toSendInfo(msg: string, data:any=null) {\n    if (data) return `{\"type\":\"send\", \"data\":{\"content\":\"${msg}\",\"parent\":\"${data[\"data\"][\"id\"]}\"}}`;\n    else return `{\"type\":\"send\", \"data\":{\"content\":\"${msg}\"}`;\n  }\n\n  incrRunCt() {\n    WS.db.get(\"RUNCOUNT\").then((value:number) => { WS.db.set(\"RUNCOUNT\", value + 1) });\n  }\n  incrPingCt() {\n    WS.db.get(\"PINGCOUNT\").then((value:number) => { WS.db.set(\"PINGCOUNT\", value + 1) });\n  }\n\n  displayStats(data:any) {\n    WS.db.get(\"RUNCOUNT\").then((value:number) => {\n      let RUNCOUNT = value;\n      WS.db.get(\"PINGCOUNT\").then((value2:number) => {\n        let PINGCOUNT = value2;\n        this.delaySendMsg(\"Run count: \"+RUNCOUNT+\"\\\\nPing count: \"+PINGCOUNT, data, 0);\n      })\n    });\n  }\n\n  bumpCallReset(data:any)\n  {\n    if (this.callReset) \n      clearTimeout(this.callReset);\n    this.callReset = setTimeout(() => {\n      this.resetCall(data); \n    }, WS.CALLTIMEOUT);\n  }\n\n  clearCallReset() {\n    if (this.callReset) clearTimeout(this.callReset);\n    this.callStatus=-1;\n  }\n\n  resetCall(this:WS, data:any) {\n    if (this.callStatus >= 0) {\n      this.sendMsg(\"[CALLEND] Disconnected from BetaOS Services\", data);\n    }\n    this.callStatus= -1;\n  }\n\n  replyMessage(msg:string, sender:string, data:any):string\n  {\n    return \"\"\n  };\n\n  delaySendMsg(msg:string, data:any, delay:number) {\n    if (delay == 0) this.sendMsg(msg, data) // instant send\n    else {\n      setTimeout(()=>{\n      this.sendMsg(msg, data)}, delay);\n    }\n    this.incrRunCt();\n  }\n\n  sendMsg(msg:string, data:any) {\n    this.socket.send(WS.toSendInfo(msg, data))\n  }\n  \n  onOpen() {\n    console.log(\"Open in \"+this.socket.url);\n    app.get('/', (req:any, res:any) => {\n    res.send(\"Open in \"+this.socket.url)\n    })\n  }\n\n  initNick() {\n    this.changeNick(this.nick)\n  }\n\n  changeNick(nick:string) {\n    this.socket.send(`{\"type\": \"nick\", \"data\": {\"name\": \"${nick}\"},\"id\": \"1\"}`);\n  }\n\n  onMessage(dat:string) {\n    let data = JSON.parse(dat);\n    if (data[\"type\"] == \"ping-event\") {\n      let reply = `{\"type\": \"ping-reply\",\"data\": {\"time\":${data[\"data\"][\"time\"]}},\"id\":\"0\"}`;\n      this.socket.send(reply);\n      setTimeout(this.initNick.bind(this), 3000);\n    }\n    if (data[\"type\"] == \"send-event\") {\n      // check whether the message contents match the pattern\n\n      let msg = data[\"data\"][\"content\"].toLowerCase().trim();\n      let snd = data[\"data\"][\"sender\"][\"name\"];\n      console.log(`[${this.roomName}][${snd}] ${msg}`);\n      // Required methods\n      // !kill\n      if (msg == \"!kill @\" + this.nick.toLowerCase()) {\n        this.sendMsg(\"/me crashes\", data);\n        setTimeout(()=>{this.socket.close(1000, \"!killed by user.\");}, 100);\n      }\n        \n      // !restore\n      else if (this.pausedQ && msg == \"!restore @\" + this.nick.toLowerCase()) {\n        this.sendMsg(\"/me has been unpaused\", data);        \n        this.pauser = null;\n        this.callTimes = [];\n        this.pausedQ = false;\n      } \n        \n      // !pause\n      else if (msg == \"!pause @\" + this.nick.toLowerCase()) {\n        this.sendMsg(\"/me has been paused\", data)\n        \n\n        let reply = \"Enter !kill @\"+this.nick+\" to kill this bot, \"+\n          \"or enter !restore @\"+this.nick+\" to restore it.\";\n        this.delaySendMsg(reply, data, 0);\n        this.pauser = snd;\n        this.pausedQ = true;\n      } \n      // check paused and pings\n      else if (this.pausedQ &&\n        (msg.match(\"!ping @\" + this.nick.toLowerCase(), \"gmiu\") ||\n         msg.match(\"!help @\" + this.nick.toLowerCase(), \"gmiu\"))) \n      {\n        this.delaySendMsg(\"/me has been paused by @\"+this.pauser, data, 0);\n        return;\n      } \n      // general unpaused ping\n      else if (msg == \"!ping\") {\n        this.sendMsg(\"Pong!\", data)\n        this.incrPingCt();\n      } \n\n      // self-specific unpaused ping\n      else if (msg.match(\"!ping @\" + this.nick.toLowerCase() + \"$\")) {\n        this.sendMsg(\":white_check_mark: BetaOS services ONLINE\", data)\n        this.incrPingCt();\n      }\n        \n      // general unpaused help\n      else if (msg == \"!help\"){\n        this.sendMsg(\"Enter !help @\"+this.nick+\" for help!\", data);\n      } \n      \n      // send to messageHandle to process messages.\n      else if (!this.pausedQ) {\n        let outStr = this.replyMessage(msg.trim(), snd, data);\n        if (this.failedQ && outStr != \"\") outStr = \"/me is rebooting.\"\n        if (outStr == \"\") return;\n        if (!this.bypass) {\n          this.callTimes.push(Date.now());\n          setTimeout(() => {this.callTimes.shift();}, 60*5*1000) // five minutes.\n        }\n        if (!this.bypass && this.callTimes.length >= 5) {\n          // if (i == 2)\n            if (this.callTimes.length < 10) {\n              outStr = this.transferOutQ?outStr+\"\\\\n[ANTISPAM] Consider moving to &bots or &test for large-scale testing. Thank you for your understanding.\"\n                : outStr+\" [ANTISPAM WARNING]\";\n            } else {\n              outStr = outStr+\"\\\\n[ANTISPAM] Automatically paused @\"+this.nick;\n              this.pausedQ = true;\n              this.pauser = \"BetaOS_ANTISPAM\";\n              this.resetCall(data);\n            }\n        }\n        this.sendMsg(outStr, data);\n      }\n    }\n  }\n\n  errorSocket() {\n    this.pausedQ = false;\n    this.pauser = null;\n    this.changeNick(this.nick + \"[Error]\")\n    this.incrRunCt();\n    this.failedQ = true;\n    setTimeout(() => {\n      this.changeNick(this.nick)\n      this.incrRunCt();\n      updateActive(this.roomName, true);\n      this.failedQ = false;\n    }, 5000);\n    updateActive(this.roomName, false);\n  } // socketclose\n\n  onClose(event:number) {\n    console.log(event)\n    if (event != 1000) {\n      updateActive(this.roomName, false);\n      setTimeout(() => {\n        new WS(this.url, this.nick, this.roomName, this.transferOutQ)\n        updateActive(this.roomName, true);\n      }, 1000);\n    } else {\n      updateActive(this.roomName, false);\n      console.log(\"[close] Connection at \"+this.url+\" was killed\");\n    }\n  }\n\n  \n  constructor(url:string, nick:string, roomName:string, transferQ:boolean) {\n    this.nick = nick;\n    this.url=url;\n    this.roomName = roomName;\n    this.socket = new WebSocket(url);\n    this.transferOutQ=transferQ;\n    this.socket.on('open', this.onOpen.bind(this));\n    this.socket.on('message', this.onMessage.bind(this));\n    this.socket.on('close', this.onClose.bind(this));\n    this.replyMessage = replyMessage\n  }\n}\n\n\ninit();"],
  "mappings": "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",
  "names": ["import_messageHandle"]
}

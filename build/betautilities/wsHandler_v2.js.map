{
  "version": 3,
  "sources": ["../../betautilities/wsHandler_v2.ts"],
  "sourcesContent": ["import {WebSocket} from 'ws';\nimport {updateActive} from '../supportRooms';\n\nexport class WS_V2\n{\n  socket:WebSocket;\n  static FAILSAFETIMEOUT:NodeJS.Timeout|null = null;\n  roomName:string;\n  nick:string;\n  url:string;\n  static sockets:WebSocket[];\n  static resetTime:number = 500;\n  \n  onOpen() {\n    console.log(\"BetaUtilities open in \"+this.socket.url);\n    WS_V2.FAILSAFETIMEOUT =setTimeout(()=>{WS_V2.resetTime =1000;}, 10000);\n  }\n\n  onClose(event:any) {\n    // console.log(\"socket closed\")\n    WS_V2.sockets.splice(WS_V2.sockets.indexOf(this), 1);\n    if (WS_V2.FAILSAFETIMEOUT) {\n      clearTimeout(WS_V2.FAILSAFETIMEOUT);\n      WS_V2.FAILSAFETIMEOUT = null;\n    }\n    // systemLog((\"Perished in:\"+this.roomName);\n    if (event != 1000 && event!=1006) {\n      updateActive(this.roomName, false);\n      console.log(\"!killed in &\"+this.roomName);\n      setTimeout(() => {\n        new WS(this.url, this.nick, this.roomName, this.transferOutQ)\n        updateActive(this.roomName, true);\n      }, 1000);\n    } else {\n      updateActive(this.roomName, false);\n      if (event==1000) return;\n      WS_V2.resetTime*=1.5;\n      if (WS_V2.resetTime > 30000) {\n        WS_V2.resetTime = 30000;\n        return;\n      }\n      setTimeout(()=>{\n        new WS(this.url, this.nick, this.roomName, this.transferOutQ)\n        updateActive(this.roomName, true);\n      }, WS_V2.resetTime);\n      \n      console.log((\"Retrying in: \"+Math.round(WS_V2.resetTime/1000)+\" seconds\"));\n      let dateStr = (new Date()).toLocaleDateString(\"en-US\", {timeZone:\"EST\"})+\"/\"+(new Date()).toLocaleTimeString(\"en-US\", {timeZone:\"EST\"});\n      console.log((\"[close] Connection at \"+this.url+\" was killed at \"+dateStr));\n    }\n  }\n\n  constructor(url:string, nick:string, roomName:string, transferQ:boolean) {\n    this.nick = nick;\n    // if (roomName == \"bots\") WS_V2.notifRoom = this;\n    WS_V2.sockets.push(this);\n    // console.log(WS_V2.sockets);\n    this.url=url;\n    this.roomName = roomName;\n    this.socket = new WebSocket(url);\n    // this.transferOutQ=transferQ;\n    this.socket.on('open', this.onOpen.bind(this));\n    this.socket.on('message', this.onMessage.bind(this));\n    this.socket.on('close', this.onClose.bind(this));\n    this.socket.on('error', (e:any)=>{\n      this.socket.close(1000, \"\");\n      // systemLog((\"ERROR for room-ID: \"+this.roomName)\n      updateActive(this.roomName, false);\n    })\n    // this.replyMessage = (msg:string, sender:string, data:any) => {\n      // return replyMessage(this, msg, sender, data);\n    // }\n  }\n}"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBAAwB;AACxB,0BAA2B;AAEpB,MAAM,MACb;AAAA,EACE;AAAA,EACA,OAAO,kBAAsC;AAAA,EAC7C;AAAA,EACA;AAAA,EACA;AAAA,EACA,OAAO;AAAA,EACP,OAAO,YAAmB;AAAA,EAE1B,SAAS;AACP,YAAQ,IAAI,2BAAyB,KAAK,OAAO,GAAG;AACpD,UAAM,kBAAiB,WAAW,MAAI;AAAC,YAAM,YAAW;AAAA,IAAK,GAAG,GAAK;AAAA,EACvE;AAAA,EAEA,QAAQ,OAAW;AAEjB,UAAM,QAAQ,OAAO,MAAM,QAAQ,QAAQ,IAAI,GAAG,CAAC;AACnD,QAAI,MAAM,iBAAiB;AACzB,mBAAa,MAAM,eAAe;AAClC,YAAM,kBAAkB;AAAA,IAC1B;AAEA,QAAI,SAAS,OAAQ,SAAO,MAAM;AAChC,4CAAa,KAAK,UAAU,KAAK;AACjC,cAAQ,IAAI,iBAAe,KAAK,QAAQ;AACxC,iBAAW,MAAM;AACf,YAAI,GAAG,KAAK,KAAK,KAAK,MAAM,KAAK,UAAU,KAAK,YAAY;AAC5D,8CAAa,KAAK,UAAU,IAAI;AAAA,MAClC,GAAG,GAAI;AAAA,IACT,OAAO;AACL,4CAAa,KAAK,UAAU,KAAK;AACjC,UAAI,SAAO;AAAM;AACjB,YAAM,aAAW;AACjB,UAAI,MAAM,YAAY,KAAO;AAC3B,cAAM,YAAY;AAClB;AAAA,MACF;AACA,iBAAW,MAAI;AACb,YAAI,GAAG,KAAK,KAAK,KAAK,MAAM,KAAK,UAAU,KAAK,YAAY;AAC5D,8CAAa,KAAK,UAAU,IAAI;AAAA,MAClC,GAAG,MAAM,SAAS;AAElB,cAAQ,IAAK,kBAAgB,KAAK,MAAM,MAAM,YAAU,GAAI,IAAE,UAAW;AACzE,UAAI,UAAW,IAAI,KAAK,EAAG,mBAAmB,SAAS,EAAC,UAAS,MAAK,CAAC,IAAE,MAAK,IAAI,KAAK,EAAG,mBAAmB,SAAS,EAAC,UAAS,MAAK,CAAC;AACtI,cAAQ,IAAK,2BAAyB,KAAK,MAAI,oBAAkB,OAAQ;AAAA,IAC3E;AAAA,EACF;AAAA,EAEA,YAAY,KAAY,MAAa,UAAiB,WAAmB;AACvE,SAAK,OAAO;AAEZ,UAAM,QAAQ,KAAK,IAAI;AAEvB,SAAK,MAAI;AACT,SAAK,WAAW;AAChB,SAAK,SAAS,IAAI,oBAAU,GAAG;AAE/B,SAAK,OAAO,GAAG,QAAQ,KAAK,OAAO,KAAK,IAAI,CAAC;AAC7C,SAAK,OAAO,GAAG,WAAW,KAAK,UAAU,KAAK,IAAI,CAAC;AACnD,SAAK,OAAO,GAAG,SAAS,KAAK,QAAQ,KAAK,IAAI,CAAC;AAC/C,SAAK,OAAO,GAAG,SAAS,CAAC,MAAQ;AAC/B,WAAK,OAAO,MAAM,KAAM,EAAE;AAE1B,4CAAa,KAAK,UAAU,KAAK;AAAA,IACnC,CAAC;AAAA,EAIH;AACF;",
  "names": []
}
